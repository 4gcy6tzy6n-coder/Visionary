# Prometheus监控配置 - Text2Loc Visionary
# 监控Text2Loc Visionary系统的性能和健康状况

global:
  scrape_interval: 15s      # 默认抓取间隔
  evaluation_interval: 15s  # 规则评估间隔
  scrape_timeout: 10s       # 抓取超时时间

# 告警管理器配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# 告警规则文件
rule_files:
  - "alerts/*.yml"
  - "rules/*.yml"

# 抓取配置
scrape_configs:
  # 监控Prometheus自身
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 15s
    metrics_path: /metrics

  # Text2Loc API服务监控
  - job_name: 'text2loc-api'
    static_configs:
      - targets:
        - 'text2loc-api:8080'  # Docker Compose服务名
        - 'localhost:8080'     # 本地开发环境
    scrape_interval: 15s
    metrics_path: /api/v1/metrics
    params:
      format: ['prometheus']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+)(?::\d+)?'
        replacement: '$1'

  # Redis缓存服务监控
  - job_name: 'text2loc-redis'
    static_configs:
      - targets:
        - 'redis:6379'        # Docker Compose服务名
        - 'localhost:6379'    # 本地开发环境
    scrape_interval: 30s
    metrics_path: /metrics
    params:
      format: ['prometheus']

  # Ollama模型服务监控
  - job_name: 'text2loc-ollama'
    static_configs:
      - targets:
        - 'ollama:11434'      # Docker Compose服务名
        - 'localhost:11434'   # 本地开发环境
    scrape_interval: 30s
    metrics_path: /api/metrics
    params:
      format: ['prometheus']

  # Node Exporter - 系统指标监控
  - job_name: 'node-exporter'
    static_configs:
      - targets:
        - 'node-exporter:9100'  # Docker Compose服务名
        - 'localhost:9100'      # 本地开发环境
    scrape_interval: 30s
    metrics_path: /metrics

  # Nginx反向代理监控
  - job_name: 'text2loc-nginx'
    static_configs:
      - targets:
        - 'nginx:80'           # Docker Compose服务名
        - 'localhost:80'       # 本地开发环境
    scrape_interval: 30s
    metrics_path: /nginx_status
    params:
      format: ['prometheus']

  # Grafana监控
  - job_name: 'grafana'
    static_configs:
      - targets:
        - 'grafana:3000'       # Docker Compose服务名
        - 'localhost:3000'     # 本地开发环境
    scrape_interval: 60s
    metrics_path: /metrics

  # 黑盒监控 - API健康检查
  - job_name: 'blackbox-api'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - 'http://text2loc-api:8080/api/v1/health'  # API健康检查
        - 'http://text2loc-api:8080/api/v1/status'  # API状态检查
        - 'http://ollama:11434/api/tags'           # Ollama健康检查
        - 'http://redis:6379'                      # Redis健康检查
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115  # 黑盒导出器地址

  # 黑盒监控 - 网站可用性
  - job_name: 'blackbox-web'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - 'http://text2loc-api:8080'       # API服务首页
        - 'http://text2loc-frontend:80'    # 前端页面
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

# 远程写入配置（可选）
remote_write:
  - url: "http://thanos-receive:10908/api/v1/receive"
    write_relabel_configs:
      - source_labels: [job]
        regex: "text2loc.*"
        action: keep

# 远程读取配置（可选）
remote_read:
  - url: "http://thanos-query:10912/api/v1/read"

# 存储配置
storage:
  tsdb:
    path: /prometheus
    retention: 15d              # 数据保留15天
    min-block-duration: 2h
    max-block-duration: 24h

# 查询日志配置
query_log:
  file: /prometheus/query.log

# 外部标签（用于联邦集群）
external_labels:
  cluster: "text2loc-production"
  environment: "production"
  region: "us-east-1"

# Web配置
web:
  page_title: "Text2Loc Visionary - Prometheus"
  max_connections: 512
  read_timeout: 5m
  enable_remote_shutdown: false
  enable_admin_api: false
  console_libraries: /usr/share/prometheus/console_libraries
  console_templates: /usr/share/prometheus/consoles
