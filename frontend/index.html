<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text2Loc - æ™ºèƒ½ä½ç½®å®šä½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #1a1a1a;
            line-height: 1.6;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .navbar-brand {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            text-decoration: none;
        }

        .navbar-nav {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 16px;
            color: #666;
            text-decoration: none;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: #f5f5f5;
            color: #1a1a1a;
        }

        .nav-link.active {
            background: #f0f0f0;
            color: #1a1a1a;
            font-weight: 500;
        }

        /* æ¨¡å‹çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .model-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 13px;
            color: #666;
        }

        .model-badge .indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #10a37f;
        }

        .model-badge .indicator.offline {
            background: #dc3545;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 100px 24px 40px;
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .page-header p {
            font-size: 16px;
            color: #666;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .input-label {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 12px;
            display: block;
        }

        .input-area {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .input-area:focus {
            outline: none;
            border-color: #10a37f;
        }

        .input-area::placeholder {
            color: #999;
        }

        /* é€‰é¡¹åŒºåŸŸ */
        .options-row {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .option-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-group label {
            font-size: 14px;
            color: #666;
        }

        .option-group input[type="number"] {
            width: 60px;
            padding: 6px 10px;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 14px;
        }

        .option-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #10a37f;
        }

        /* è¯­éŸ³è¾“å…¥æŒ‰é’® */
        .voice-input-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .voice-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .voice-input-btn.listening {
            animation: voicePulse 1.5s ease-in-out infinite;
        }

        @keyframes voicePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
        }

        .voice-input-btn .mic-icon {
            font-size: 20px;
        }

        /* æˆ–åˆ†éš”çº¿ */
        .divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: #999;
            font-size: 13px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e5e5;
        }

        .divider span {
            padding: 0 16px;
        }

        /* æäº¤æŒ‰é’® */
        .submit-btn {
            width: 100%;
            padding: 14px 24px;
            background: #10a37f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background: #0d8c6d;
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-section {
            display: none;
            text-align: center;
            padding: 48px 24px;
        }

        .loading-section.active {
            display: block;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top-color: #10a37f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #666;
            font-size: 14px;
        }

        /* ç»“æœåŒºåŸŸ */
        .results-section {
            display: none;
            margin-top: 32px;
        }

        .results-section.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* æŸ¥è¯¢åˆ†æå¡ç‰‡ */
        .analysis-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e5e5e5;
        }

        .analysis-item:last-child {
            border-bottom: none;
        }

        .analysis-label {
            color: #666;
            font-size: 14px;
        }

        .analysis-value {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 14px;
        }

        /* ç»“æœåˆ—è¡¨ */
        .result-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .result-item {
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }

        .result-item:hover {
            border-color: #10a37f;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .result-item.top-result {
            border-color: #10a37f;
            background: #f6fffd;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .result-rank {
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .result-item.top-result .result-rank {
            color: #10a37f;
        }

        .result-score {
            font-size: 14px;
            font-weight: 600;
            color: #10a37f;
        }

        .result-description {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            margin: 8px 0;
        }

        .result-coordinates {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 8px 0;
            font-size: 14px;
        }

        .coord-label {
            color: #666;
            font-weight: 500;
        }

        .coord-value {
            color: #1a1a1a;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .result-reference {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            font-size: 13px;
        }

        .ref-label {
            color: #888;
        }

        .ref-value {
            color: #666;
        }

        /* ä¼šè¯çŠ¶æ€æ˜¾ç¤º */
        .session-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            padding: 12px 16px;
            background: #f0f7ff;
            border: 1px solid #d0e3ff;
            border-radius: 8px;
        }

        .session-label {
            font-size: 13px;
            font-weight: 500;
            color: #1a73e8;
        }

        .session-id {
            flex: 1;
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        .end-session-btn {
            padding: 6px 12px;
            background: #fff;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .end-session-btn:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #f0f0f0;
        }

        .stat-box {
            text-align: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }

        /* æ¾„æ¸…é—®é¢˜ */
        .clarification-box {
            background: #fff9e6;
            border: 1px solid #ffd700;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .clarification-title {
            font-size: 14px;
            font-weight: 600;
            color: #856404;
            margin-bottom: 8px;
        }

        .clarification-question {
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 12px;
        }

        .suggestion-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-tag {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ffd700;
            border-radius: 16px;
            font-size: 13px;
            color: #856404;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-tag:hover {
            background: #ffd700;
            color: #1a1a1a;
        }

        /* é”™è¯¯æç¤º */
        .error-box {
            background: #fff5f5;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 16px;
            color: #c62828;
            font-size: 14px;
        }

        /* ç¤ºä¾‹æç¤º */
        .examples-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid #f0f0f0;
        }

        .examples-title {
            font-size: 14px;
            font-weight: 500;
            color: #666;
            margin-bottom: 12px;
        }

        .example-item {
            padding: 10px 14px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .example-item:hover {
            background: #e8f5f1;
            color: #10a37f;
        }

        /* é¡µè„š */
        .footer {
            text-align: center;
            padding: 40px 24px;
            color: #999;
            font-size: 13px;
            border-top: 1px solid #f0f0f0;
            margin-top: 60px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="./index.html" class="navbar-brand">Text2Loc</a>
        <div class="model-badge" id="modelBadge">
            <span class="indicator"></span>
            <span id="modelText">åŠ è½½ä¸­...</span>
        </div>
        <div class="navbar-nav">
            <a href="./index.html" class="nav-link active">æ–‡æœ¬ç‰ˆ</a>
            <a href="./voice.html" class="nav-link">è¯­éŸ³ç‰ˆ</a>
            <a href="./config.html" class="nav-link">é…ç½®</a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h1>æ™ºèƒ½ä½ç½®å®šä½</h1>
            <p>è¾“å…¥è‡ªç„¶è¯­è¨€æè¿°ï¼Œè·å–ç²¾å‡†ä½ç½®ä¿¡æ¯</p>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-section">
            <label class="input-label" id="inputLabel">ä½ç½®æè¿°</label>
            <textarea 
                class="input-area" 
                id="queryInput"
            ></textarea>

            <div class="options-row">
                <div class="option-group">
                    <label>è¿”å›ç»“æœæ•°ï¼š</label>
                    <input type="number" id="topK" value="5" min="1" max="20">
                </div>
                <div class="option-group">
                    <input type="checkbox" id="enhancedMode" checked>
                    <label for="enhancedMode">å¯ç”¨å¢å¼ºæ¨¡å¼</label>
                </div>
                <div class="option-group">
                    <input type="checkbox" id="interactiveMode" onchange="onInteractiveModeChange()">
                    <label for="interactiveMode">äº¤äº’å¼æ¨¡å¼</label>
                </div>
            </div>

            <!-- è¯­éŸ³è¾“å…¥æŒ‰é’® -->
            <button class="voice-input-btn" id="voiceBtn" onclick="toggleVoiceInput()">
                <span class="mic-icon">ğŸ¤</span>
                <span id="voiceBtnText">è¯­éŸ³è¾“å…¥</span>
            </button>

            <div class="divider">
                <span>æˆ–</span>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitQuery()">
                å¼€å§‹å®šä½
            </button>
            
            <!-- ä¼šè¯çŠ¶æ€æ˜¾ç¤ºï¼ˆäº¤äº’å¼æ¨¡å¼ï¼‰ -->
            <div class="session-status" id="sessionStatus" style="display: none;">
                <span class="session-label">ä¼šè¯çŠ¶æ€</span>
                <span class="session-id" id="sessionIdDisplay">-</span>
                <button class="end-session-btn" onclick="endSession()">ç»“æŸä¼šè¯</button>
            </div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading-section" id="loadingSection">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">æ­£åœ¨å¤„ç†...</div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div class="results-section" id="resultsSection">
            <!-- æŸ¥è¯¢åˆ†æ -->
            <div class="section-title">æŸ¥è¯¢åˆ†æ</div>
            <div class="analysis-card" id="analysisCard">
                <div class="analysis-item">
                    <span class="analysis-label">åŸå§‹æè¿°</span>
                    <span class="analysis-value" id="originalQuery">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">è¯†åˆ«æ–¹å‘</span>
                    <span class="analysis-value" id="parsedDirection">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">è¯†åˆ«é¢œè‰²</span>
                    <span class="analysis-value" id="parsedColor">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">è¯†åˆ«å¯¹è±¡</span>
                    <span class="analysis-value" id="parsedObject">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">è§£ææ¨¡å‹</span>
                    <span class="analysis-value" id="parseModel">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">è§£æè€—æ—¶</span>
                    <span class="analysis-value" id="parseTime">-</span>
                </div>
            </div>

            <!-- æ¾„æ¸…é—®é¢˜ -->
            <div class="clarification-box" id="clarificationBox" style="display: none;">
                <div class="clarification-title">éœ€è¦æ›´å¤šä¿¡æ¯</div>
                <div class="clarification-question" id="clarificationQuestion"></div>
                <div class="suggestion-tags" id="suggestionTags"></div>
            </div>

            <!-- å®šä½ç»“æœ -->
            <div class="section-title">å®šä½ç»“æœ</div>
            <div class="result-list" id="resultList"></div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-value" id="statTime">-</div>
                    <div class="stat-label">å¤„ç†æ—¶é—´</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statConfidence">-</div>
                    <div class="stat-label">ç½®ä¿¡åº¦</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statResults">-</div>
                    <div class="stat-label">ç»“æœæ•°é‡</div>
                </div>
            </div>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div class="error-box" id="errorBox" style="display: none;"></div>
    </div>

    <!-- é¡µè„š -->
    <footer class="footer">
        Text2Loc Visionary &copy; 2024
    </footer>

    <script>
        // æ™ºèƒ½æ£€æµ‹APIåœ°å€
        function getApiBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            // å¦‚æœæ˜¯localhostæˆ–127.0.0.1ï¼Œç›´æ¥ä½¿ç”¨5050ç«¯å£
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:5050';
            }
            
            // å¦‚æœæ˜¯iPhoneé€šè¿‡å†…ç½‘IPè®¿é—®ï¼Œä½¿ç”¨ç›¸åŒIPä¸åŒç«¯å£
            if (hostname.match(/^192\.168\./) || hostname.match(/^10\./)) {
                return `http://${hostname}:5050`;
            }
            
            // å…¶ä»–æƒ…å†µï¼Œä½¿ç”¨å½“å‰åŸŸå
            return window.location.origin;
        }
        
        const API_BASE_URL = getApiBaseUrl();
        console.log('ğŸ”Œ APIåœ°å€:', API_BASE_URL);
        let sessionId = null;
        let queryStartTime = null;
        let progressInterval = null;
        let queryHistory = [];  // ä¿å­˜æŸ¥è¯¢å†å²

        // åŠ è½½æ¨¡å‹é…ç½®
        async function loadModelConfig() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/config`);
                const data = await response.json();

                if (data.status === 'success') {
                    const modelText = document.getElementById('modelText');
                    const indicator = document.querySelector('.model-badge .indicator');

                    if (data.is_configured) {
                        modelText.textContent = `${data.provider} / ${data.model}`;
                        indicator.classList.remove('offline');
                    } else {
                        modelText.textContent = 'æœªé…ç½®';
                        indicator.classList.add('offline');
                    }
                }
            } catch (error) {
                document.getElementById('modelText').textContent = 'è¿æ¥å¤±è´¥';
                document.querySelector('.model-badge .indicator').classList.add('offline');
            }
        }

        document.addEventListener('DOMContentLoaded', loadModelConfig);

        function setQuery(text) {
            document.getElementById('queryInput').value = text;
        }

        function updateProgress() {
            if (queryStartTime) {
                const elapsed = Math.floor((Date.now() - queryStartTime) / 1000);
                const loadingText = document.getElementById('loadingText');
                if (elapsed > 3) {
                    loadingText.textContent = `æ­£åœ¨å¤„ç†... (${elapsed}s)`;
                }
            }
        }

        // äº¤äº’å¼æ¨¡å¼åˆ‡æ¢å¤„ç†
        function onInteractiveModeChange() {
            const interactiveMode = document.getElementById('interactiveMode').checked;
            if (!interactiveMode) {
                // å…³é—­äº¤äº’å¼æ¨¡å¼æ—¶é‡ç½®çŠ¶æ€
                endSession();
            }
        }

        async function submitQuery() {
            const queryInput = document.getElementById('queryInput');
            const query = queryInput.value.trim();
            const topK = parseInt(document.getElementById('topK').value);
            const enhancedMode = document.getElementById('enhancedMode').checked;
            const interactiveMode = document.getElementById('interactiveMode').checked;

            if (!query) {
                alert(sessionId ? 'è¯·è¾“å…¥è¡¥å……ä¿¡æ¯' : 'è¯·è¾“å…¥ä½ç½®æè¿°');
                return;
            }

            // ä¿å­˜æŸ¥è¯¢åˆ°å†å²
            if (!sessionId) {
                queryHistory = [query];
            } else {
                queryHistory.push(query);
            }

            // åˆ›å»ºä¼šè¯ID
            if (interactiveMode && !sessionId) {
                sessionId = 'web_' + Date.now().toString(36);
            }

            // æ˜¾ç¤ºåŠ è½½
            document.getElementById('loadingSection').classList.add('active');
            document.getElementById('resultsSection').classList.remove('active');
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;

            queryStartTime = Date.now();
            progressInterval = setInterval(updateProgress, 1000);

            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        top_k: topK,
                        enable_enhanced: enhancedMode,
                        session_id: sessionId,
                        interactive: interactiveMode
                    })
                });

                clearInterval(progressInterval);
                const data = await response.json();

                if (data.status === 'error') {
                    throw new Error(data.error);
                }

                if (data.session_id) {
                    sessionId = data.session_id;
                }

                // æ›´æ–°UIçŠ¶æ€
                if (interactiveMode && data.need_clarification) {
                    // è¿›å…¥è¡¥å……ä¿¡æ¯æ¨¡å¼
                    updateInteractiveUI(true, data.clarification_question);
                } else {
                    // å®Œæˆæˆ–ç»“æŸ
                    if (interactiveMode) {
                        // äº¤äº’å¼æ¨¡å¼å®Œæˆï¼Œä¿æŒçŠ¶æ€ä½†æ¸…ç©ºè¾“å…¥
                        queryInput.value = '';
                    } else {
                        // éäº¤äº’æ¨¡å¼ï¼Œå®Œå…¨é‡ç½®
                        endSession();
                    }
                }

                displayResults(data);

            } catch (error) {
                clearInterval(progressInterval);
                document.getElementById('errorBox').textContent = error.message;
                document.getElementById('errorBox').style.display = 'block';
            } finally {
                document.getElementById('loadingSection').classList.remove('active');
                document.getElementById('submitBtn').disabled = false;
            }
        }

        // æ›´æ–°äº¤äº’å¼UIçŠ¶æ€
        function updateInteractiveUI(isFollowup, question) {
            const inputLabel = document.getElementById('inputLabel');
            const submitBtn = document.getElementById('submitBtn');
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionIdDisplay = document.getElementById('sessionIdDisplay');

            if (isFollowup) {
                // è¡¥å……ä¿¡æ¯æ¨¡å¼
                inputLabel.textContent = 'è¡¥å……ä¿¡æ¯';
                submitBtn.textContent = 'å†æ¬¡å®šä½';
                sessionStatus.style.display = 'flex';
                sessionIdDisplay.textContent = sessionId ? sessionId.substring(0, 15) + '...' : '-';
            } else {
                // åˆå§‹æ¨¡å¼
                inputLabel.textContent = 'ä½ç½®æè¿°';
                submitBtn.textContent = 'å¼€å§‹å®šä½';
                sessionStatus.style.display = 'none';
            }
        }

        // ç»“æŸä¼šè¯
        function endSession() {
            sessionId = null;
            queryHistory = [];
            document.getElementById('queryInput').value = '';
            updateInteractiveUI(false);
        }

        // ==================== è¯­éŸ³è¯†åˆ«åŠŸèƒ½ ====================
        let recognition = null;
        let isListening = false;
        let permissionGranted = false;

        // æ£€æŸ¥éº¦å…‹é£æƒé™
        async function checkMicrophonePermission() {
            try {
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        const result = await navigator.permissions.query({ name: 'microphone' });
                        if (result.state === 'granted') {
                            permissionGranted = true;
                            return true;
                        } else if (result.state === 'denied') {
                            return false;
                        }
                    } catch (e) {
                        console.log('Permissions API ä¸æ”¯æŒ');
                    }
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                permissionGranted = true;
                stream.getTracks().forEach(track => track.stop());
                return true;
            } catch (error) {
                permissionGranted = false;
                return false;
            }
        }

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                document.getElementById('voiceBtn').style.display = 'none';
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN'; // é»˜è®¤ä½¿ç”¨æ™®é€šè¯

            recognition.onstart = () => {
                isListening = true;
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceBtnText = document.getElementById('voiceBtnText');
                voiceBtn.classList.add('listening');
                voiceBtnText.textContent = 'æ­£åœ¨è†å¬...';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const queryInput = document.getElementById('queryInput');
                if (finalTranscript) {
                    queryInput.value = finalTranscript;
                } else if (interimTranscript) {
                    queryInput.value = interimTranscript;
                }
            };

            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                let errorMsg = 'è¯­éŸ³è¯†åˆ«å‡ºé”™';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMsg = 'æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                        break;
                    case 'audio-capture':
                        errorMsg = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                        permissionGranted = false;
                        break;
                    case 'not-allowed':
                        errorMsg = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„å›¾æ ‡å…è®¸è®¿é—®';
                        permissionGranted = false;
                        break;
                    case 'network':
                        errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        break;
                    case 'service-not-allowed':
                        errorMsg = 'è¯­éŸ³æœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®';
                        break;
                }
                
                alert(errorMsg);
                stopVoiceInput();
            };

            recognition.onend = () => {
                stopVoiceInput();
            };

            return true;
        }

        // åœæ­¢è¯­éŸ³è¯†åˆ«
        function stopVoiceInput() {
            isListening = false;
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceBtnText = document.getElementById('voiceBtnText');
            voiceBtn.classList.remove('listening');
            voiceBtnText.textContent = 'è¯­éŸ³è¾“å…¥';
            
            if (recognition) {
                recognition.stop();
            }
        }

        // åˆ‡æ¢è¯­éŸ³è¯†åˆ«çŠ¶æ€
        async function toggleVoiceInput() {
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ Chromeã€Edge æˆ– Safari æµè§ˆå™¨');
                    return;
                }
            }

            if (isListening) {
                recognition.stop();
            } else {
                // æ£€æŸ¥æƒé™
                if (!permissionGranted) {
                    const granted = await checkMicrophonePermission();
                    if (!granted) {
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®');
                        return;
                    }
                }
                
                try {
                    // è¯·æ±‚éº¦å…‹é£æƒé™
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    recognition.start();
                } catch (err) {
                    console.error('éº¦å…‹é£æƒé™é”™è¯¯:', err);
                    
                    if (err.name === 'NotAllowedError') {
                        alert('éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚è¯·ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„å›¾æ ‡ï¼Œé€‰æ‹©â€œç½‘ç«™è®¾ç½®â€ï¼Œå…è®¸éº¦å…‹é£è®¿é—®ã€‚');
                    } else if (err.name === 'NotFoundError') {
                        alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡ã€‚è¯·ç¡®ä¿éº¦å…‹é£å·²æ­£ç¡®è¿æ¥ã€‚');
                    } else {
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                    }
                    
                    permissionGranted = false;
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        document.addEventListener('DOMContentLoaded', async () => {
            initSpeechRecognition();
            await checkMicrophonePermission();
        });

        function displayResults(data) {
            const analysis = data.query_analysis || {};

            // å¡«å……åˆ†æç»“æœ
            document.getElementById('originalQuery').textContent = data.query || '-';
            document.getElementById('parsedDirection').textContent = analysis.direction || '-';
            document.getElementById('parsedColor').textContent = analysis.color || '-';
            document.getElementById('parsedObject').textContent = analysis.object || '-';
            document.getElementById('parseModel').textContent = analysis.nlu_model || '-';
            document.getElementById('parseTime').textContent = analysis.parse_time_ms ? 
                analysis.parse_time_ms.toFixed(0) + 'ms' : '-';

            // æ¾„æ¸…é—®é¢˜
            const clarificationBox = document.getElementById('clarificationBox');
            if (data.need_clarification && data.clarification_question) {
                clarificationBox.style.display = 'block';
                document.getElementById('clarificationQuestion').textContent = data.clarification_question;

                const tagsContainer = document.getElementById('suggestionTags');
                tagsContainer.innerHTML = '';
                if (data.suggestions) {
                    data.suggestions.forEach(suggestion => {
                        const tag = document.createElement('span');
                        tag.className = 'suggestion-tag';
                        tag.textContent = suggestion;
                        tag.onclick = () => setQuery(suggestion);
                        tagsContainer.appendChild(tag);
                    });
                }
            } else {
                clarificationBox.style.display = 'none';
            }

            // ç»“æœåˆ—è¡¨
            const resultList = document.getElementById('resultList');
            resultList.innerHTML = '';

            const results = data.retrieval_results || [];
            results.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'result-item' + (index === 0 ? ' top-result' : '');
                const refObjects = result.reference_objects && result.reference_objects.length > 0 
                    ? result.reference_objects.join(', ') 
                    : 'æ— ';
                item.innerHTML = `
                    <div class="result-header">
                        <span class="result-rank">#${index + 1}</span>
                        <span class="result-score">${(result.confidence * 100).toFixed(1)}%</span>
                    </div>
                    <div class="result-coordinates">
                        <span class="coord-label">åæ ‡:</span>
                        <span class="coord-value">(${result.x !== undefined ? result.x.toFixed(2) : '0.00'}, ${result.y !== undefined ? result.y.toFixed(2) : '0.00'})</span>
                    </div>
                    <div class="result-description">${result.description || 'æ— æè¿°'}</div>
                    <div class="result-reference">
                        <span class="ref-label">å‚è€ƒå¯¹è±¡:</span>
                        <span class="ref-value">${refObjects}</span>
                    </div>
                `;
                resultList.appendChild(item);
            });

            // ç»Ÿè®¡
            document.getElementById('statTime').textContent = 
                data.processing_time_ms ? data.processing_time_ms.toFixed(0) + 'ms' : '-';
            document.getElementById('statConfidence').textContent = 
                analysis.confidence ? (analysis.confidence * 100).toFixed(0) + '%' : '-';
            document.getElementById('statResults').textContent = results.length;

            document.getElementById('resultsSection').classList.add('active');
        }

    </script>
</body>
</html>
