import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react-swc';
import legacy from '@vitejs/plugin-legacy';
import { VitePWA } from 'vite-plugin-pwa';
import viteCompression from 'vite-plugin-compression';
import svgr from 'vite-plugin-svgr';
import { resolve } from 'path';
import type { UserConfig } from 'vite';

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => {
  // 加载环境变量
  const env = loadEnv(mode, process.cwd(), '');

  return {
    // 项目根目录
    root: resolve(__dirname, '.'),

    // 基础路径
    base: env.VITE_BASE_PATH || '/',

    // 开发服务器配置
    server: {
      // 服务器主机名
      host: true,
      // 端口号
      port: parseInt(env.VITE_PORT || '5173'),
      // 自动打开浏览器
      open: false,
      // 启用热更新
      hmr: {
        overlay: true,
      },
      // 代理配置，将API请求转发到后端
      proxy: {
        '/api': {
          target: env.VITE_API_BASE_URL || 'http://localhost:8080',
          changeOrigin: true,
          secure: false,
          rewrite: (path) => path,
          configure: (proxy, _options) => {
            proxy.on('error', (err, _req, _res) => {
              console.log('proxy error', err);
            });
            proxy.on('proxyReq', (proxyReq, req, _res) => {
              console.log('Sending Request to the Target:', req.method, req.url);
            });
            proxy.on('proxyRes', (proxyRes, req, _res) => {
              console.log('Received Response from the Target:', proxyRes.statusCode, req.url);
            });
          },
        },
        '/ws': {
          target: env.VITE_API_BASE_URL || 'http://localhost:8080',
          changeOrigin: true,
          secure: false,
          ws: true,
        },
      },
      // 跨域配置
      cors: true,
      // 预请求配置
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, PATCH, OPTIONS',
        'Access-Control-Allow-Headers': 'X-Requested-With, Content-Type, Authorization',
      },
    },

    // 预览服务器配置
    preview: {
      port: parseInt(env.VITE_PREVIEW_PORT || '4173'),
      host: true,
    },

    // 插件配置
    plugins: [
      // React + SWC 插件，提供极速的HMR
      react({
        jsxImportSource: '@emotion/react',
        // 启用TypeScript装饰器
        tsDecorators: true,
        // SWC插件配置
        plugins: [['@swc/plugin-emotion', {}]],
      }),

      // SVG转换插件
      svgr({
        svgrOptions: {
          exportType: 'default',
          ref: true,
          svgo: false,
          titleProp: true,
        },
        include: '**/*.svg',
      }),

      // 浏览器兼容性插件
      legacy({
        targets: [
          '>0.2%',
          'not dead',
          'not op_mini all',
          'ios_saf >= 12',
          'chrome >= 80',
          'firefox >= 78',
          'safari >= 13',
          'edge >= 88',
        ],
        modernPolyfills: true,
        renderLegacyChunks: false,
      }),

      // PWA插件
      VitePWA({
        registerType: 'autoUpdate',
        includeAssets: ['favicon.ico', 'robots.txt', 'apple-touch-icon.png'],
        manifest: {
          name: 'Text2Loc Visionary',
          short_name: 'Text2Loc',
          description: '3D Point Cloud Localization from Natural Language',
          theme_color: '#1a202c',
          background_color: '#1a202c',
          display: 'standalone',
          orientation: 'any',
          scope: '/',
          start_url: '/',
          icons: [
            {
              src: '/icon-192x192.png',
              sizes: '192x192',
              type: 'image/png',
            },
            {
              src: '/icon-512x512.png',
              sizes: '512x512',
              type: 'image/png',
            },
            {
              src: '/icon-512x512.png',
              sizes: '512x512',
              type: 'image/png',
              purpose: 'maskable',
            },
          ],
        },
        workbox: {
          // 开发环境不生成service worker
          disableDevLogs: true,
          globPatterns: ['**/*.{js,css,html,ico,png,svg,woff,woff2}'],
          runtimeCaching: [
            {
              urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
              handler: 'CacheFirst',
              options: {
                cacheName: 'google-fonts-cache',
                expiration: {
                  maxEntries: 10,
                  maxAgeSeconds: 60 * 60 * 24 * 365, // 1年
                },
                cacheableResponse: {
                  statuses: [0, 200],
                },
              },
            },
            {
              urlPattern: /^https:\/\/fonts\.gstatic\.com\/.*/i,
              handler: 'CacheFirst',
              options: {
                cacheName: 'gstatic-fonts-cache',
                expiration: {
                  maxEntries: 10,
                  maxAgeSeconds: 60 * 60 * 24 * 365,
                },
                cacheableResponse: {
                  statuses: [0, 200],
                },
              },
            },
            {
              urlPattern: /\/api\/.*/i,
              handler: 'NetworkFirst',
              options: {
                cacheName: 'api-cache',
                networkTimeoutSeconds: 10,
                expiration: {
                  maxEntries: 100,
                  maxAgeSeconds: 60 * 60, // 1小时
                },
                cacheableResponse: {
                  statuses: [0, 200, 304],
                },
              },
            },
          ],
        },
      }),

      // Gzip压缩插件
      viteCompression({
        verbose: true,
        disable: false,
        threshold: 10240,
        algorithm: 'gzip',
        ext: '.gz',
      }),
      // Brotli压缩插件
      viteCompression({
        verbose: true,
        disable: false,
        threshold: 10240,
        algorithm: 'brotliCompress',
        ext: '.br',
      }),
    ],

    // 解析配置
    resolve: {
      // 别名配置
      alias: {
        '@': resolve(__dirname, 'src'),
        '@api': resolve(__dirname, 'src/api'),
        '@components': resolve(__dirname, 'src/components'),
        '@features': resolve(__dirname, 'src/features'),
        '@hooks': resolve(__dirname, 'src/hooks'),
        '@stores': resolve(__dirname, 'src/stores'),
        '@types': resolve(__dirname, 'src/types'),
        '@utils': resolve(__dirname, 'src/utils'),
        '@styles': resolve(__dirname, 'src/styles'),
        '@assets': resolve(__dirname, 'src/assets'),
      },
      // 扩展名配置
      extensions: [
        '.mjs',
        '.js',
        '.ts',
        '.jsx',
        '.tsx',
        '.json',
        '.css',
        '.scss',
        '.svg',
      ],
    },

    // 构建配置
    build: {
      // 输出目录
      outDir: 'dist',
      // 静态资源目录
      assetsDir: 'assets',
      // 是否生成sourcemap
      sourcemap: mode !== 'production',
      // 最小化配置
      minify: 'terser',
      terserOptions: {
        compress: {
          drop_console: mode === 'production',
          drop_debugger: mode === 'production',
        },
      },
      // 代码分割配置
      rollupOptions: {
        output: {
          // 代码分割策略
          manualChunks: {
            // 第三方库分离
            'vendor-react': ['react', 'react-dom', 'react-router-dom'],
            'vendor-state': ['zustand', '@tanstack/react-query'],
            'vendor-ui': ['@chakra-ui/react', '@emotion/react', '@emotion/styled', 'framer-motion'],
            'vendor-viz': ['three', '@react-three/fiber', '@react-three/drei', 'recharts', 'd3'],
            'vendor-utils': ['axios', 'lodash', 'dayjs', 'clsx', 'uuid'],
          },
          // 入口文件命名
          entryFileNames: 'assets/[name].[hash].js',
          // chunk文件命名
          chunkFileNames: 'assets/[name].[hash].js',
          // 资源文件命名
          assetFileNames: ({ name }) => {
            if (/\.(gif|jpe?g|png|svg)$/.test(name ?? '')) {
              return 'assets/images/[name].[hash][extname]';
            }
            if (/\.css$/.test(name ?? '')) {
              return 'assets/css/[name].[hash][extname]';
            }
            if (/\.(woff|woff2|eot|ttf|otf)$/.test(name ?? '')) {
              return 'assets/fonts/[name].[hash][extname]';
            }
            return 'assets/[name].[hash][extname]';
          },
        },
        // 外部依赖
        external: [],
      },
      // 目标浏览器
      target: 'es2020',
      // CSS代码分割
      cssCodeSplit: true,
      // 资源大小限制（警告）
      assetsInlineLimit: 4096,
      // 块大小警告限制
      chunkSizeWarningLimit: 1000,
      // 是否启用CSS压缩
      cssMinify: mode === 'production',
      // 是否生成manifest文件
      manifest: true,
      // 是否生成预加载文件
      reportCompressedSize: false,
    },

    // 优化配置
    optimizeDeps: {
      include: [
        'react',
        'react-dom',
        'react-router-dom',
        'axios',
        '@tanstack/react-query',
        'zustand',
        '@chakra-ui/react',
        '@emotion/react',
        'framer-motion',
        'three',
        '@react-three/fiber',
        'react-hook-form',
      ],
      exclude: ['@swc/core'],
      // 强制预构建
      force: true,
    },

    // 环境变量前缀
    envPrefix: 'VITE_',

    // 实验性功能
    experimental: {
      // 渲染策略
      renderBuiltUrl(filename: string) {
        return { relative: true };
      },
    },

    // 自定义配置
    custom: {
      // 构建分析
      bundleAnalysis: env.VITE_BUNDLE_ANALYSIS === 'true',
    },
  } as UserConfig;
});
