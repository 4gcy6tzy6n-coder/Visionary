<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜ç²¾åº¦è¯­éŸ³è¯†åˆ« - Text2Loc</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: #ffffff;
            border: 1px solid #e5e5e5;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .engine-selector {
            margin-bottom: 30px;
        }
        
        .engine-label {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 10px;
            display: block;
        }
        
        .engine-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .engine-btn {
            padding: 12px 16px;
            border: 2px solid #e5e5e5;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .engine-btn:hover {
            border-color: #10a37f;
            background: #f0fdf9;
        }
        
        .engine-btn.active {
            border-color: #10a37f;
            background: #10a37f;
            color: white;
        }
        
        .engine-btn .badge {
            display: inline-block;
            background: #10a37f;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }
        
        .status-card {
            background: #f8f9fa;
            border: 1px solid #e5e5e5;
            color: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status-text {
            font-size: 16px;
        }
        
        .mic-container {
            text-align: center;
            margin: 30px 0;
        }
        
        .mic-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #10a37f;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
            transition: all 0.3s ease;
        }
        
        .mic-button:hover {
            transform: scale(1.05);
        }
        
        .mic-button:active {
            transform: scale(0.95);
        }
        
        .mic-button.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 163, 127, 0.6); }
            50% { box-shadow: 0 0 0 20px rgba(16, 163, 127, 0); }
        }
        
        .mic-icon {
            width: 50px;
            height: 50px;
        }
        
        .result-box {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 120px;
        }
        
        .result-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .result-text {
            color: #1a1a1a;
            font-size: 18px;
            line-height: 1.6;
            min-height: 60px;
        }
        
        .result-placeholder {
            color: #999;
            font-size: 14px;
        }
        
        .confidence-bar {
            margin-top: 10px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10a37f 0%, #1ea97c 100%);
            transition: width 0.3s;
        }
        
        .send-btn {
            width: 100%;
            padding: 16px;
            background: #10a37f;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background: #0d8a6a;
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .info-box {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            font-size: 13px;
            color: #856404;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">ğŸ¤ é«˜ç²¾åº¦è¯­éŸ³è¯†åˆ«</h1>
            <p class="subtitle">Text2Loc - å¤šå¼•æ“æ”¯æŒ</p>
        </div>
        
        <!-- å¼•æ“é€‰æ‹© -->
        <div class="engine-selector">
            <label class="engine-label">é€‰æ‹©è¯†åˆ«å¼•æ“ï¼š</label>
            <div class="engine-buttons">
                <button class="engine-btn active" data-engine="browser" onclick="selectEngine('browser')">
                    æµè§ˆå™¨åŸç”Ÿ<span class="badge">å…è´¹</span>
                </button>
                <button class="engine-btn" data-engine="whisper" onclick="selectEngine('whisper')">
                    OpenAI Whisper<span class="badge">é«˜ç²¾åº¦</span>
                </button>
                <button class="engine-btn" data-engine="azure" onclick="selectEngine('azure')">
                    Azure è¯­éŸ³<span class="badge">ä¼ä¸šçº§</span>
                </button>
                <button class="engine-btn" data-engine="aliyun" onclick="selectEngine('aliyun')">
                    é˜¿é‡Œäº‘<span class="badge">æ¨è</span>
                </button>
            </div>
        </div>
        
        <!-- çŠ¶æ€å¡ç‰‡ -->
        <div class="status-card">
            <p class="status-text" id="status">å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»éº¦å…‹é£å¼€å§‹</p>
        </div>
        
        <!-- éº¦å…‹é£æŒ‰é’® -->
        <div class="mic-container">
            <button class="mic-button" id="micBtn" onclick="toggleVoice()">
                <svg class="mic-icon" viewBox="0 0 24 24" fill="white" id="micIcon">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </button>
        </div>
        
        <!-- è¯†åˆ«ç»“æœ -->
        <div class="result-box">
            <div class="result-label">è¯†åˆ«ç»“æœï¼š</div>
            <p class="result-text result-placeholder" id="result">è¯†åˆ«åˆ°çš„æ–‡æœ¬å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
            <div class="confidence-bar">
                <div class="confidence-fill" id="confidenceBar" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- å‘é€æŒ‰é’® -->
        <button class="send-btn" id="sendBtn" onclick="sendText()" disabled>å‘é€åˆ°Macè¿›è¡Œå®šä½</button>
        
        <!-- æç¤ºä¿¡æ¯ -->
        <div class="info-box" id="infoBox">
            <strong>æµè§ˆå™¨åŸç”Ÿå¼•æ“</strong><br>
            â€¢ å®Œå…¨å…è´¹ï¼Œæ— éœ€é…ç½®<br>
            â€¢ é€‚ç”¨äºç®€å•æŸ¥è¯¢<br>
            â€¢ å‡†ç¡®ç‡çº¦80-85%
        </div>
    </div>
    
    <div class="connection-status" id="connection">è¿æ¥çŠ¶æ€: æ£€æŸ¥ä¸­...</div>
    
    <script>
        let recognition;
        let isListening = false;
        let recognizedText = '';
        let currentEngine = 'browser';
        let audioRecorder = null;
        let audioChunks = [];
        
        const MAC_API_URL = 'http://192.168.0.106:5050';
        
        // å¼•æ“é…ç½®
        const engineConfigs = {
            browser: {
                name: 'æµè§ˆå™¨åŸç”Ÿ',
                info: 'å®Œå…¨å…è´¹ï¼Œæ— éœ€é…ç½®<br>é€‚ç”¨äºç®€å•æŸ¥è¯¢<br>å‡†ç¡®ç‡çº¦80-85%',
                requiresAPI: false
            },
            whisper: {
                name: 'OpenAI Whisper',
                info: 'ä¸šç•Œé¢†å…ˆçš„è¯­éŸ³è¯†åˆ«<br>æ”¯æŒå¤šè¯­è¨€ï¼Œå‡†ç¡®ç‡95%+<br>éœ€è¦OpenAI API Key',
                requiresAPI: true,
                endpoint: '/api/v1/voice/whisper'
            },
            azure: {
                name: 'Azure è¯­éŸ³æœåŠ¡',
                info: 'å¾®è½¯ä¼ä¸šçº§æœåŠ¡<br>ä½å»¶è¿Ÿï¼Œå‡†ç¡®ç‡98%+<br>éœ€è¦Azureè®¢é˜…',
                requiresAPI: true,
                endpoint: '/api/v1/voice/azure'
            },
            aliyun: {
                name: 'é˜¿é‡Œäº‘è¯­éŸ³',
                info: 'å›½å†…æ¨èï¼Œé€Ÿåº¦å¿«<br>ä¸­æ–‡å‡†ç¡®ç‡97%+<br>éœ€è¦é˜¿é‡Œäº‘APIå¯†é’¥',
                requiresAPI: true,
                endpoint: '/api/v1/voice/aliyun'
            }
        };
        
        // è·å–APIåœ°å€
        function getApiBaseUrl() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (!isLocalhost && window.location.protocol === 'https:') {
                return window.location.origin;
            }
            
            return MAC_API_URL;
        }
        
        // é€‰æ‹©å¼•æ“
        function selectEngine(engine) {
            currentEngine = engine;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.engine-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-engine="${engine}"]`).classList.add('active');
            
            // æ›´æ–°ä¿¡æ¯æ¡†
            const config = engineConfigs[engine];
            document.getElementById('infoBox').innerHTML = `
                <strong>${config.name}</strong><br>
                ${config.info}
            `;
            
            updateStatus(`å·²åˆ‡æ¢åˆ° ${config.name}`);
        }
        
        // æ£€æŸ¥è¿æ¥
        async function checkConnection() {
            const apiBase = getApiBaseUrl();
            try {
                const response = await fetch(`${apiBase}/health`);
                document.getElementById('connection').textContent = 'âœ… Macåç«¯å·²è¿æ¥';
                return true;
            } catch (e) {
                document.getElementById('connection').textContent = 'âŒ æ— æ³•è¿æ¥Macåç«¯';
                return false;
            }
        }
        
        // åˆ‡æ¢è¯­éŸ³è¯†åˆ«
        function toggleVoice() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }
        
        // å¼€å§‹å½•éŸ³
        async function startListening() {
            if (currentEngine === 'browser') {
                startBrowserRecognition();
            } else {
                await startAudioRecording();
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopListening() {
            if (currentEngine === 'browser') {
                stopBrowserRecognition();
            } else {
                stopAudioRecording();
            }
        }
        
        // æµè§ˆå™¨åŸç”Ÿè¯†åˆ«
        function startBrowserRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                updateStatus('âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                return;
            }
            
            if (!recognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';
                recognition.maxAlternatives = 3;
                
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('micBtn').classList.add('listening');
                    updateStatus('ğŸ¤ æ­£åœ¨è†å¬...è¯·è¯´è¯');
                };
                
                recognition.onresult = (event) => {
                    let interim = '';
                    let final = '';
                    let confidence = 0;
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const result = event.results[i];
                        const transcript = result[0].transcript;
                        confidence = result[0].confidence;
                        
                        if (result.isFinal) {
                            final += transcript;
                        } else {
                            interim += transcript;
                        }
                    }
                    
                    if (final) {
                        recognizedText = final;
                        displayResult(final, confidence);
                        updateStatus('âœ… è¯†åˆ«å®Œæˆ');
                        document.getElementById('sendBtn').disabled = false;
                    } else if (interim) {
                        displayResult(interim + '...', 0);
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('è¯†åˆ«é”™è¯¯:', event.error);
                    if (event.error !== 'no-speech') {
                        updateStatus('âŒ è¯†åˆ«é”™è¯¯: ' + event.error);
                    }
                    stopBrowserRecognition();
                };
                
                recognition.onend = () => {
                    stopBrowserRecognition();
                };
            }
            
            try {
                recognition.start();
            } catch (e) {
                console.error('å¯åŠ¨å¤±è´¥:', e);
                updateStatus('âŒ å¯åŠ¨å¤±è´¥');
            }
        }
        
        function stopBrowserRecognition() {
            isListening = false;
            if (recognition) {
                recognition.stop();
            }
            document.getElementById('micBtn').classList.remove('listening');
        }
        
        // éŸ³é¢‘å½•åˆ¶ï¼ˆç”¨äºäº‘ç«¯è¯†åˆ«ï¼‰
        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                audioRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                audioRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioForRecognition(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                audioRecorder.start();
                isListening = true;
                document.getElementById('micBtn').classList.add('listening');
                updateStatus('ğŸ¤ æ­£åœ¨å½•éŸ³...ï¼ˆç‚¹å‡»åœæ­¢ï¼‰');
                
            } catch (e) {
                console.error('å½•éŸ³å¤±è´¥:', e);
                updateStatus('âŒ æ— æ³•è®¿é—®éº¦å…‹é£');
            }
        }
        
        function stopAudioRecording() {
            if (audioRecorder && audioRecorder.state !== 'inactive') {
                audioRecorder.stop();
                isListening = false;
                document.getElementById('micBtn').classList.remove('listening');
                updateStatus('â³ æ­£åœ¨è¯†åˆ«...');
            }
        }
        
        // å‘é€éŸ³é¢‘åˆ°äº‘ç«¯è¯†åˆ«
        async function sendAudioForRecognition(audioBlob) {
            const apiBase = getApiBaseUrl();
            const config = engineConfigs[currentEngine];
            
            updateStatus('â³ æ­£åœ¨è¯†åˆ«...');
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob);
                formData.append('engine', currentEngine);
                
                const response = await fetch(`${apiBase}${config.endpoint}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    recognizedText = data.text;
                    displayResult(data.text, data.confidence || 0.9);
                    updateStatus('âœ… è¯†åˆ«å®Œæˆ');
                    document.getElementById('sendBtn').disabled = false;
                } else {
                    updateStatus('âŒ è¯†åˆ«å¤±è´¥');
                }
            } catch (e) {
                console.error('è¯†åˆ«è¯·æ±‚å¤±è´¥:', e);
                updateStatus('âŒ è¯†åˆ«æœåŠ¡ä¸å¯ç”¨');
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResult(text, confidence) {
            const resultEl = document.getElementById('result');
            resultEl.textContent = text;
            resultEl.classList.remove('result-placeholder');
            
            const confidenceBar = document.getElementById('confidenceBar');
            confidenceBar.style.width = (confidence * 100) + '%';
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
        
        // å‘é€æ–‡æœ¬åˆ°Mac
        async function sendText() {
            if (!recognizedText.trim()) {
                updateStatus('âš ï¸ æ²¡æœ‰å¯å‘é€çš„æ–‡æœ¬');
                return;
            }
            
            const apiBase = getApiBaseUrl();
            updateStatus('ğŸ“¡ æ­£åœ¨å‘é€...');
            
            try {
                const response = await fetch(`${apiBase}/api/v1/remote-voice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: recognizedText,
                        timestamp: new Date().toISOString(),
                        device: 'iPhone',
                        engine: currentEngine
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const cellId = result.result?.final_result?.cell_id || 'å¤„ç†ä¸­';
                    const confidence = result.result?.final_result?.confidence || 0;
                    updateStatus(`âœ… å®šä½æˆåŠŸ!\nCell: ${cellId}\nç½®ä¿¡åº¦: ${(confidence*100).toFixed(1)}%`);
                } else {
                    updateStatus('âŒ å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (e) {
                console.error('å‘é€å¤±è´¥:', e);
                updateStatus('âŒ æ— æ³•è¿æ¥åˆ°Mac');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        window.onload = function() {
            checkConnection();
        };
    </script>
</body>
</html>
